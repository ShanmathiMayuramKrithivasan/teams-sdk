"use strict";(self.webpackChunkteams_md=self.webpackChunkteams_md||[]).push([[4185],{22491:(e,n,t)=>{t.d(n,{A:()=>a});t(63696);var i=t(11750);const s={tabItem:"tabItem_wHwb"};var r=t(62540);function a({children:e,hidden:n,className:t}){return(0,r.jsx)("div",{role:"tabpanel",className:(0,i.A)(s.tabItem,t),hidden:n,children:e})}},26802:(e,n,t)=>{t.d(n,{A:()=>r});var i=t(22147),s=t(62540);function r({language:e,children:n}){return(0,i.zy)().pathname.includes(`/${e}/`)?(0,s.jsx)(s.Fragment,{children:n}):null}},43023:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var i=t(63696);const s={},r=i.createContext(s);function a(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:n},e.children)}},44501:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/regional-auth-3250ef60a7ab8517b0b8366c075c68a5.png"},45282:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>u,default:()=>g,frontMatter:()=>l,metadata:()=>i,toc:()=>h});const i=JSON.parse('{"id":"typescript/in-depth-guides/user-authentication","title":"\ud83d\udd12 User Authentication","description":"\x3c!--","source":"@site/docs/main/typescript/in-depth-guides/user-authentication.mdx","sourceDirName":"typescript/in-depth-guides","slug":"/typescript/in-depth-guides/user-authentication","permalink":"/teams-sdk/typescript/in-depth-guides/user-authentication","draft":false,"unlisted":false,"editUrl":"https://github.com/microsoft/teams-sdk/tree/main/teams.md/docs/main/typescript/in-depth-guides/user-authentication.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"sidebar_label":"\ud83d\udd12 User Authentication","title":"\ud83d\udd12 User Authentication","summary":"API guide to implement User Authentication with SSO in Teams Apps."},"sidebar":"default","previous":{"title":"Link Unfurling","permalink":"/teams-sdk/typescript/in-depth-guides/message-extensions/link-unfurling"},"next":{"title":"\ud83e\udd16 AI","permalink":"/teams-sdk/typescript/in-depth-guides/ai/"}}');var s=t(62540),r=t(43023),a=t(26802),o=t(78296),c=t(22491);const l={sidebar_position:4,sidebar_label:"\ud83d\udd12 User Authentication",title:"\ud83d\udd12 User Authentication",summary:"API guide to implement User Authentication with SSO in Teams Apps."},u="\ud83d\udd12 User Authentication",d={},h=[{value:"Project Setup",id:"project-setup",level:2},{value:"Create an app with the <code>graph</code> template",id:"create-an-app-with-the-graph-template",level:3},{value:"Add Agents Toolkit auth configuration",id:"add-agents-toolkit-auth-configuration",level:3},{value:"Configure the OAuth connection",id:"configure-the-oauth-connection",level:2},{value:"Signing In",id:"signing-in",level:2},{value:"Subscribe to the SignIn event",id:"subscribe-to-the-signin-event",level:2},{value:"Start using the graph client",id:"start-using-the-graph-client",level:2},{value:"Signing Out",id:"signing-out",level:2},{value:"Regional Configs",id:"regional-configs",level:2},{value:"Resources",id:"resources",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"-user-authentication",children:"\ud83d\udd12 User Authentication"})}),"\n",(0,s.jsx)(n.p,{children:"At times agents must access secured online resources on behalf of the user, such as checking email, checking on flight status, or placing an order. To enable this, the user must authenticate their identity and grant consent for the application to access these resources. This process results in the application receiving a token, which the application can then use to access the permitted resources on the user's behalf."}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["This is an advanced guide. It is highly recommended that you are familiar with ",(0,s.jsx)(n.a,{href:"/teams/core-concepts",children:"Teams Core Concepts"})," before attempting this guide."]})}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsxs)(n.p,{children:["User authentication does not work with the developer tools setup. You have to run the app in Teams. Follow these ",(0,s.jsx)(n.a,{href:"/typescript/getting-started/running-in-teams#debugging-in-teams",children:"instructions"})," to run your app in Teams."]})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["It is possible to authenticate the user into ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-identity-providers?view=azure-bot-service-4.0&tabs=adv2%2Cga2#other-identity-providers",children:"other auth providers"})," like Facebook, Github, Google, Dropbox, and so on."]})}),"\n",(0,s.jsxs)(n.p,{children:["Once you have configured your Azure Bot resource OAuth settings, as described in the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-authentication?view=azure-bot-service-4.0",children:"official documentation"}),", add the following code to your ",(0,s.jsx)(n.code,{children:"App"}),":"]}),"\n",(0,s.jsx)(n.h2,{id:"project-setup",children:"Project Setup"}),"\n",(0,s.jsxs)(n.h3,{id:"create-an-app-with-the-graph-template",children:["Create an app with the ",(0,s.jsx)(n.code,{children:"graph"})," template"]}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"Skip this step if you want to add the auth configurations to an existing app."})}),"\n",(0,s.jsxs)(a.A,{language:"typescript",children:[(0,s.jsx)(n.p,{children:"Use your terminal to run the following command:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"npx @microsoft/teams.cli@latest new typescript oauth-app --template graph\n"})}),(0,s.jsx)(n.p,{children:"This command:"}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Creates a new directory called ",(0,s.jsx)(n.code,{children:"oauth-app"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Bootstraps the graph agent template files into it under ",(0,s.jsx)(n.code,{children:"oauth-app/src"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Creates your agent's manifest files, including a ",(0,s.jsx)(n.code,{children:"manifest.json"})," file and placeholder icons in the ",(0,s.jsx)(n.code,{children:"oauth-app/appPackage"})," directory."]}),"\n"]})]}),"\n",(0,s.jsx)(n.h3,{id:"add-agents-toolkit-auth-configuration",children:"Add Agents Toolkit auth configuration"}),"\n",(0,s.jsx)(n.p,{children:"Open your terminal with the project folder set as the current working directory and run the following command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"npx @microsoft/teams.cli config add atk.oauth\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"atk.oauth"})," configuration is a basic setup for Agents Toolkit along with configurations to authenticate the user with Microsoft Entra ID to access Microsoft Graph APIs."]}),"\n",(0,s.jsxs)(n.p,{children:["This ",(0,s.jsx)(n.a,{href:"/developer-tools/cli",children:"CLI"})," command adds configuration files required by Agents Toolkit, including:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Azure Application Entra ID manifest file ",(0,s.jsx)(n.code,{children:"aad.manifest.json"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Azure bicep files to provision Azure bot in ",(0,s.jsx)(n.code,{children:"infra/"})," folder."]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["Agents Toolkit, in the debugging flow, will deploy the ",(0,s.jsx)(n.code,{children:"aad.manifest.json"})," and ",(0,s.jsx)(n.code,{children:"infra/azure.local.bicep"})," file to provision the Application Entra ID and Azure bot with oauth configurations."]})}),"\n",(0,s.jsx)(n.h2,{id:"configure-the-oauth-connection",children:"Configure the OAuth connection"}),"\n",(0,s.jsx)(a.A,{language:"typescript",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { App } from '@microsoft/teams.apps';\nimport * as endpoints from '@microsoft/teams.graph-endpoints';\n\nconst app = new App({\n  oauth: {\n    defaultConnectionName: 'graph',\n  },\n});\n"})})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"Make sure you use the same name you used when creating the OAuth connection in the Azure Bot Service resource."})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["In many templates, ",(0,s.jsx)(n.code,{children:"graph"})," is the default name of the OAuth connection, but you can change that by supplying a different connection name in your app configuration."]})}),"\n",(0,s.jsx)(n.h2,{id:"signing-in",children:"Signing In"}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["This uses the Single Sign-On (SSO) authentication flow. To learn more about all the available flows and their differences see the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-authentication?view=azure-bot-service-4.0",children:"official documentation"}),"."]})}),"\n",(0,s.jsxs)(n.p,{children:["You must call the ",(0,s.jsx)(n.code,{children:"signin"})," method inside your route handler, for example: to signin when receiving the ",(0,s.jsx)(n.code,{children:"/signin"})," message:"]}),"\n",(0,s.jsx)(a.A,{language:"typescript",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"app.message('/signin', async ({ signin, send }) => {\n  if (await signin()) {\n    await send('you are already signed in!');\n  }\n});\n"})})}),"\n",(0,s.jsx)(n.h2,{id:"subscribe-to-the-signin-event",children:"Subscribe to the SignIn event"}),"\n",(0,s.jsxs)(n.p,{children:["You can subscribe to the ",(0,s.jsx)(n.code,{children:"signin"})," event, that will be triggered once the OAuth flow completes."]}),"\n",(0,s.jsx)(a.A,{language:"typescript",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"app.event('signin', async ({ send, token }) => {\n  await send(\n    `Signed in using OAuth connection ${token.connectionName}. Please type **/whoami** to see your profile or **/signout** to sign out.`\n  );\n});\n"})})}),"\n",(0,s.jsx)(n.h2,{id:"start-using-the-graph-client",children:"Start using the graph client"}),"\n",(0,s.jsxs)(n.p,{children:["From this point, you can use the ",(0,s.jsx)(n.code,{children:"IsSignedIn"})," flag and the ",(0,s.jsx)(n.code,{children:"userGraph"})," client to query graph, for example to reply to the ",(0,s.jsx)(n.code,{children:"/whoami"})," message, or in any other route."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["The default OAuth configuration requests the ",(0,s.jsx)(n.code,{children:"User.ReadBasic.All"})," permission. It is possible to request other permissions by modifying the App Registration for the bot on Azure."]})}),"\n",(0,s.jsx)(a.A,{language:"typescript",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import * as endpoints from \'@microsoft/teams.graph-endpoints\';\n\napp.message(\'/whoami\', async ({ send, userGraph, signin }) => {\n  if (!await signin()) {\n    return;\n  }\n  const me = await userGraph.call(endpoints.me.get);\n  await send(\n    `you are signed in as "${me.displayName}" and your email is "${me.mail || me.userPrincipalName}"`\n  );\n});\n\napp.on(\'message\', async ({ send, activity, signin }) => {\n  if (await signin()) {\n    await send(\n      `You said: "${activity.text}". Please type **/whoami** to see your profile or **/signout** to sign out.`\n    );\n  } else {\n    await send(`You said: "${activity.text}". Please type **/signin** to sign in.`);\n  }\n});\n'})})}),"\n",(0,s.jsx)(n.h2,{id:"signing-out",children:"Signing Out"}),"\n",(0,s.jsxs)(n.p,{children:["You can signout by calling the ",(0,s.jsx)(n.code,{children:"signout"})," method, this will remove the token from the User Token service cache"]}),"\n",(0,s.jsx)(a.A,{language:"typescript",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"app.message('/signout', async ({ send, signout, isSignedIn }) => {\n  if (!isSignedIn) return;\n  await signout();\n  await send('you have been signed out!');\n});\n"})})}),"\n",(0,s.jsxs)(a.A,{language:"typescript",children:[(0,s.jsx)(n.h2,{id:"regional-configs",children:"Regional Configs"}),(0,s.jsx)(n.p,{children:"You may be building a regional bot that is deployed in a specific Azure region (such as West Europe, East US, etc.) rather than global. This is important for organizations that have data residency requirements or want to reduce latency by keeping data and authentication flows within a specific area."}),(0,s.jsx)(n.p,{children:"These examples use West Europe, but follow the equivalent for other regions."}),(0,s.jsxs)(o.A,{children:[(0,s.jsxs)(c.A,{value:"portal",label:"Azure Portal",children:[(0,s.jsx)(n.p,{children:"To configure a new regional bot in Azure, you must setup your resoures in the desired region. Your resource group must also be in the same region."}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Deploy a new App Registration in ",(0,s.jsx)(n.code,{children:"westeurope"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Deploy and link a new Enterprise Application (Service Principal) on Microsoft Entra in ",(0,s.jsx)(n.code,{children:"westeurope"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Deploy and link a new Azure Bot in ",(0,s.jsx)(n.code,{children:"westeurope"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["In your App Registration, in the ",(0,s.jsx)(n.code,{children:"Authentication (Preview)"})," tab, add a ",(0,s.jsx)(n.code,{children:"Redirect URI"})," for the Platform Type ",(0,s.jsx)(n.code,{children:"Web"})," to your regional endpoint (e.g., ",(0,s.jsx)(n.code,{children:"https://europe.token.botframework.com/.auth/web/redirect"}),")"]}),"\n"]}),(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Authentication Tab",src:t(44501).A+"",width:"1876",height:"682"})}),(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsxs)(n.li,{children:["In your ",(0,s.jsx)(n.code,{children:".env"})," file (or wherever you set your environment variables), add your ",(0,s.jsx)(n.code,{children:"OAUTH_URL"}),". For example:\n",(0,s.jsx)(n.code,{children:"OAUTH_URL=https://europe.token.botframework.com"})]}),"\n"]})]}),(0,s.jsxs)(c.A,{value:"atk",label:"Agents Toolkit",children:[(0,s.jsx)(n.p,{children:"To configure a new regional bot with ATK, you will need to make a few updates. Note that this assumes you have not yet deployed the bot previously."}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.code,{children:"azurebot.bicep"}),", replace all ",(0,s.jsx)(n.code,{children:"global"})," occurrences to ",(0,s.jsx)(n.code,{children:"westeurope"})]}),"\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.code,{children:"manifest.json"}),", in ",(0,s.jsx)(n.code,{children:"validDomains"}),", ",(0,s.jsx)(n.code,{children:"*.botframework.com"})," should be replaced by ",(0,s.jsx)(n.code,{children:"europe.token.botframework.com"})]}),"\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.code,{children:"aad.manifest.json"}),", replace ",(0,s.jsx)(n.code,{children:"https://token.botframework.com/.auth/web/redirect"})," with ",(0,s.jsx)(n.code,{children:"https://europe.token.botframework.com/.auth/web/redirect"})]}),"\n",(0,s.jsxs)(n.li,{children:["In your ",(0,s.jsx)(n.code,{children:".env"})," file, add your ",(0,s.jsx)(n.code,{children:"OAUTH_URL"}),". For example:\n",(0,s.jsx)(n.code,{children:"OAUTH_URL=https://europe.token.botframework.com"})]}),"\n"]})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"resources",children:"Resources"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-authentication?view=azure-bot-service-4.0",children:"User Authentication Basics"})})]})}function g(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},78296:(e,n,t)=>{t.d(n,{A:()=>A});var i=t(63696),s=t(11750),r=t(53237),a=t(90766),o=t(22147),c=t(14395),l=t(35043),u=t(44544),d=t(41506);function h(e){return i.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,i.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function p(e){const{values:n,children:t}=e;return(0,i.useMemo)((()=>{const e=n??function(e){return h(e).map((({props:{value:e,label:n,attributes:t,default:i}})=>({value:e,label:n,attributes:t,default:i})))}(t);return function(e){const n=(0,u.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function g({value:e,tabValues:n}){return n.some((n=>n.value===e))}function m({queryString:e=!1,groupId:n}){const t=(0,o.W6)(),s=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(s),(0,i.useCallback)((e=>{if(!s)return;const n=new URLSearchParams(t.location.search);n.set(s,e),t.replace({...t.location,search:n.toString()})}),[s,t])]}function f(e){const{defaultValue:n,queryString:t=!1,groupId:s}=e,r=p(e),[a,o]=(0,i.useState)((()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!g({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find((e=>e.default))??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:r}))),[l,u]=m({queryString:t,groupId:s}),[h,f]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,s]=(0,d.Dv)(n);return[t,(0,i.useCallback)((e=>{n&&s.set(e)}),[n,s])]}({groupId:s}),x=(()=>{const e=l??h;return g({value:e,tabValues:r})?e:null})();(0,c.A)((()=>{x&&o(x)}),[x]);return{selectedValue:a,selectValue:(0,i.useCallback)((e=>{if(!g({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);o(e),u(e),f(e)}),[u,f,r]),tabValues:r}}var x=t(86681);const j={tabList:"tabList_J5MA",tabItem:"tabItem_l0OV"};var b=t(62540);function y({className:e,block:n,selectedValue:t,selectValue:i,tabValues:r}){const o=[],{blockElementScrollPositionUntilNextRender:c}=(0,a.a_)(),l=e=>{const n=e.currentTarget,s=o.indexOf(n),a=r[s].value;a!==t&&(c(n),i(a))},u=e=>{let n=null;switch(e.key){case"Enter":l(e);break;case"ArrowRight":{const t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{const t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.A)("tabs",{"tabs--block":n},e),children:r.map((({value:e,label:n,attributes:i})=>(0,b.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{o.push(e)},onKeyDown:u,onClick:l,...i,className:(0,s.A)("tabs__item",j.tabItem,i?.className,{"tabs__item--active":t===e}),children:n??e},e)))})}function v({lazy:e,children:n,selectedValue:t}){const r=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=r.find((e=>e.props.value===t));return e?(0,i.cloneElement)(e,{className:(0,s.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:r.map(((e,n)=>(0,i.cloneElement)(e,{key:n,hidden:e.props.value!==t})))})}function w(e){const n=f(e);return(0,b.jsxs)("div",{className:(0,s.A)(r.G.tabs.container,"tabs-container",j.tabList),children:[(0,b.jsx)(y,{...n,...e}),(0,b.jsx)(v,{...n,...e})]})}function A(e){const n=(0,x.A)();return(0,b.jsx)(w,{...e,children:h(e.children)},String(n))}}}]);
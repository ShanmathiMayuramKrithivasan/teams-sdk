"use strict";(self.webpackChunkteams_md=self.webpackChunkteams_md||[]).push([[3603],{16569:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>c,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"csharp/in-depth-guides/user-authentication","title":"\ud83d\udd12 User Authentication","description":"\x3c!--","source":"@site/docs/main/csharp/in-depth-guides/user-authentication.mdx","sourceDirName":"csharp/in-depth-guides","slug":"/csharp/in-depth-guides/user-authentication","permalink":"/teams-sdk/csharp/in-depth-guides/user-authentication","draft":false,"unlisted":false,"editUrl":"https://github.com/microsoft/teams-sdk/tree/main/teams.md/docs/main/csharp/in-depth-guides/user-authentication.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"sidebar_label":"\ud83d\udd12 User Authentication","title":"\ud83d\udd12 User Authentication","summary":"API guide to implement User Authentication with SSO in Teams Apps."},"sidebar":"default","previous":{"title":"Link Unfurling","permalink":"/teams-sdk/csharp/in-depth-guides/message-extensions/link-unfurling"},"next":{"title":"\ud83e\udd16 AI","permalink":"/teams-sdk/csharp/in-depth-guides/ai/"}}');var s=t(62540),a=t(43023),o=t(26802);const r={sidebar_position:4,sidebar_label:"\ud83d\udd12 User Authentication",title:"\ud83d\udd12 User Authentication",summary:"API guide to implement User Authentication with SSO in Teams Apps."},c="\ud83d\udd12 User Authentication",h={},d=[{value:"Project Setup",id:"project-setup",level:2},{value:"Create an app with the <code>graph</code> template",id:"create-an-app-with-the-graph-template",level:3},{value:"Add Agents Toolkit auth configuration",id:"add-agents-toolkit-auth-configuration",level:3},{value:"Configure the OAuth connection",id:"configure-the-oauth-connection",level:2},{value:"Signing In",id:"signing-in",level:2},{value:"Subscribe to the SignIn event",id:"subscribe-to-the-signin-event",level:2},{value:"Start using the graph client",id:"start-using-the-graph-client",level:2},{value:"Signing Out",id:"signing-out",level:2},{value:"Resources",id:"resources",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"-user-authentication",children:"\ud83d\udd12 User Authentication"})}),"\n",(0,s.jsx)(n.p,{children:"At times agents must access secured online resources on behalf of the user, such as checking email, checking on flight status, or placing an order. To enable this, the user must authenticate their identity and grant consent for the application to access these resources. This process results in the application receiving a token, which the application can then use to access the permitted resources on the user's behalf."}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["This is an advanced guide. It is highly recommended that you are familiar with ",(0,s.jsx)(n.a,{href:"/teams/core-concepts",children:"Teams Core Concepts"})," before attempting this guide."]})}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsxs)(n.p,{children:["User authentication does not work with the developer tools setup. You have to run the app in Teams. Follow these ",(0,s.jsx)(n.a,{href:"/typescript/getting-started/running-in-teams#debugging-in-teams",children:"instructions"})," to run your app in Teams."]})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["It is possible to authenticate the user into ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-identity-providers?view=azure-bot-service-4.0&tabs=adv2%2Cga2#other-identity-providers",children:"other auth providers"})," like Facebook, Github, Google, Dropbox, and so on."]})}),"\n",(0,s.jsxs)(n.p,{children:["Once you have configured your Azure Bot resource OAuth settings, as described in the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-authentication?view=azure-bot-service-4.0",children:"official documentation"}),", add the following code to your ",(0,s.jsx)(n.code,{children:"App"}),":"]}),"\n",(0,s.jsx)(n.h2,{id:"project-setup",children:"Project Setup"}),"\n",(0,s.jsxs)(n.h3,{id:"create-an-app-with-the-graph-template",children:["Create an app with the ",(0,s.jsx)(n.code,{children:"graph"})," template"]}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"Skip this step if you want to add the auth configurations to an existing app."})}),"\n",(0,s.jsxs)(o.A,{language:"csharp",children:[(0,s.jsx)(n.p,{children:"Use your terminal to run the following command:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"npx @microsoft/teams.cli@latest new csharp oauth-app --template graph\n"})})]}),"\n",(0,s.jsx)(n.h3,{id:"add-agents-toolkit-auth-configuration",children:"Add Agents Toolkit auth configuration"}),"\n",(0,s.jsx)(n.p,{children:"Open your terminal with the project folder set as the current working directory and run the following command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"npx @microsoft/teams.cli config add atk.oauth\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"atk.oauth"})," configuration is a basic setup for Agents Toolkit along with configurations to authenticate the user with Microsoft Entra ID to access Microsoft Graph APIs."]}),"\n",(0,s.jsxs)(n.p,{children:["This ",(0,s.jsx)(n.a,{href:"/developer-tools/cli",children:"CLI"})," command adds configuration files required by Agents Toolkit, including:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Azure Application Entra ID manifest file ",(0,s.jsx)(n.code,{children:"aad.manifest.json"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Azure bicep files to provision Azure bot in ",(0,s.jsx)(n.code,{children:"infra/"})," folder."]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["Agents Toolkit, in the debugging flow, will deploy the ",(0,s.jsx)(n.code,{children:"aad.manifest.json"})," and ",(0,s.jsx)(n.code,{children:"infra/azure.local.bicep"})," file to provision the Application Entra ID and Azure bot with oauth configurations."]})}),"\n",(0,s.jsx)(n.h2,{id:"configure-the-oauth-connection",children:"Configure the OAuth connection"}),"\n",(0,s.jsx)(o.A,{language:"csharp",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'var builder = WebApplication.CreateBuilder(args);\n\nvar appBuilder = App.Builder()\n    .AddOAuth("graph");\n\nbuilder.AddTeams(appBuilder);\nvar app = builder.Build();\nvar teams = app.UseTeams();\n'})})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"Make sure you use the same name you used when creating the OAuth connection in the Azure Bot Service resource."})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["In many templates, ",(0,s.jsx)(n.code,{children:"graph"})," is the default name of the OAuth connection, but you can change that by supplying a different connection name in your app configuration."]})}),"\n",(0,s.jsx)(n.h2,{id:"signing-in",children:"Signing In"}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["This uses the Single Sign-On (SSO) authentication flow. To learn more about all the available flows and their differences see the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-authentication?view=azure-bot-service-4.0",children:"official documentation"}),"."]})}),"\n",(0,s.jsxs)(n.p,{children:["You must call the ",(0,s.jsx)(n.code,{children:"signin"})," method inside your route handler, for example: to signin when receiving the ",(0,s.jsx)(n.code,{children:"/signin"})," message:"]}),"\n",(0,s.jsx)(o.A,{language:"csharp",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'teams.OnMessage("/signin", async context =>\n{\n    if (context.IsSignedIn)\n    {\n        await context.Send("you are already signed in!");\n        return;\n    }\n    else\n    {\n        await context.SignIn();\n    }\n});\n'})})}),"\n",(0,s.jsx)(n.h2,{id:"subscribe-to-the-signin-event",children:"Subscribe to the SignIn event"}),"\n",(0,s.jsxs)(n.p,{children:["You can subscribe to the ",(0,s.jsx)(n.code,{children:"signin"})," event, that will be triggered once the OAuth flow completes."]}),"\n",(0,s.jsx)(o.A,{language:"csharp",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'teams.OnSignIn(async (_, teamsEvent) =>\n{\n    var context = teamsEvent.Context;\n    await context.Send($"Signed in using OAuth connection {context.ConnectionName}. Please type **/whoami** to see your profile or **/signout** to sign out.");\n});\n'})})}),"\n",(0,s.jsx)(n.h2,{id:"start-using-the-graph-client",children:"Start using the graph client"}),"\n",(0,s.jsxs)(n.p,{children:["From this point, you can use the ",(0,s.jsx)(n.code,{children:"IsSignedIn"})," flag and the ",(0,s.jsx)(n.code,{children:"userGraph"})," client to query graph, for example to reply to the ",(0,s.jsx)(n.code,{children:"/whoami"})," message, or in any other route."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["The default OAuth configuration requests the ",(0,s.jsx)(n.code,{children:"User.ReadBasic.All"})," permission. It is possible to request other permissions by modifying the App Registration for the bot on Azure."]})}),"\n",(0,s.jsx)(o.A,{language:"csharp",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'teams.OnMessage("/whoami", async context =>\n{\n    if (!context.IsSignedIn)\n    {\n        await context.Send("you are not signed in!. Please type **/signin** to sign in");\n        return;\n    }\n    var me = await context.GetUserGraphClient().Me.GetAsync();\n    await context.Send($"user \\"{me!.DisplayName}\\" signed in.");\n});\n\nteams.OnMessage(async context =>\n{\n    if (context.IsSignedIn)\n    {\n        await context.Send($"You said : {context.Activity.Text}.  Please type **/whoami** to see your profile or **/signout** to sign out.");\n    }\n    else\n    {\n        await context.Send($"You said : {context.Activity.Text}.  Please type **/signin** to sign in.");\n    }\n});\n'})})}),"\n",(0,s.jsx)(n.h2,{id:"signing-out",children:"Signing Out"}),"\n",(0,s.jsxs)(n.p,{children:["You can signout by calling the ",(0,s.jsx)(n.code,{children:"signout"})," method, this will remove the token from the User Token service cache"]}),"\n",(0,s.jsx)(o.A,{language:"csharp",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cs",children:'teams.OnMessage("/signout", async context =>\n{\n    if (!context.IsSignedIn)\n    {\n        await context.Send("you are not signed in!");\n        return;\n    }\n\n    await context.SignOut();\n    await context.Send("you have been signed out!");\n});\n'})})}),"\n",(0,s.jsx)(n.h2,{id:"resources",children:"Resources"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-authentication?view=azure-bot-service-4.0",children:"User Authentication Basics"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},26802:(e,n,t)=>{t.d(n,{A:()=>a});var i=t(22147),s=t(62540);function a({language:e,children:n}){return(0,i.zy)().pathname.includes(`/${e}/`)?(0,s.jsx)(s.Fragment,{children:n}):null}},43023:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var i=t(63696);const s={},a=i.createContext(s);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);